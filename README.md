[![Pipeline](https://github.com/FacuMastri/fastapi-server/actions/workflows/pipeline.yml/badge.svg?branch=main)](https://github.com/FacuMastri/fastapi-server/actions/workflows/pipeline.yml)
[![codecov](https://codecov.io/gh/FacuMastri/fastapi-server/branch/main/graph/badge.svg?token=RdVC85n674)](https://codecov.io/gh/FacuMastri/fastapi-server)
[![](https://img.shields.io/badge/license-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![](https://img.shields.io/badge/python-3.6-blue.svg)](https://www.python.org/downloads/)
[![](https://img.shields.io/badge/docs-fastapi-blue.svg)](https://fastapi.tiangolo.com/)
![](https://img.shields.io/badge/version-0.1-blue.svg)


# FastAPI template


## Installing the project

The only dependency required to use this template is [poetry](https://python-poetry.org). The recommended method to install it is through [pip](https://pypi.org/project/pip/).

```bash
$ pip3 install poetry
$ poetry config virtualenvs.in-project true
```

Remember to commit to the repo the `poetry.lock` file generated by `poetry install`.


## Dependencies

The virtual environment is automatically created and activated via poetry.

```
$ cd to-project-path
$ poetry install
```

To make sure everything is set up correctly, run the following command which must show the virtual environment path:

```
$ poetry show -v
```

If still having problems, you can run `source` command to enable the virtual environment from the shell:

```
$ poetry show -v
Using virtualenv: /home/<User>/<path>/taller2/fastapi-template/.venv
$ source .venv/bin/activate
```

### Adding new dependencies

Check the [full poetry docs](https://python-poetry.org/docs/cli/), but here goes a quick reminder,

```bash
poetry add <dependency> [--dev]
```

### Style guide

This template follows [PEP8](https://www.python.org/dev/peps/pep-0008/).

For this purpose, we use:

- [black](https://github.com/psf/black): an opinionated code formatting tool
- [flake8](https://github.com/PyCQA/flake8): a tool to enforce style guide
- [pylint](https://github.com/PyCQA/pylint): a source code, bug and quality checker

**Linters**

```bash
flake8 && pylint <module_name>
```

**Formatter**
```bash
black .
```

## Running the server

- Development: `uvicorn src.main:app --reload`
- Production: `uvicorn src.main:app`
- Production Container: `docker-compose up -d`

## API Documentation

Documentation will be automatically generated at `{app}/docs`

## Tests

We use the [pytest framework](https://fastapi.tiangolo.com/tutorial/testing/) to test. The easiest way to run tests is `pytest`.
Remember to create functions with a name that starts with `test_` (this is standard pytest conventions).

## Github Actions

A few pipelines have been set to run on github actions to ensure code quality and deployment.

- Run Linter
- Run Tests
- Upload Test Coverage
- Deploy to Heroku using docker image

### Upload Coverage to Codecov

The pipeline automatically generates a coverage report and uploads it to [codecov](https://about.codecov.io/)

You'll need to set the following actions secrets:

- `CODECOV_TOKEN`: Repo Token. Can be obtained on codecov when setting up or on settings

## Heroku

You'll need to set the following actions secrets:

- `HEROKU_APP_NAME`: App name
- `HEROKU_EMAIL`: Account email
- `HEROKU_API_KEY`: Account [API key](https://dashboard.heroku.com/account)

## Datadog

The heroku Dockerfile includes the DataDog agent.  Create a new DataDog API Key from [here](https://app.datadoghq.com/organization-settings/api-keys).
Also, you need to set the following config vars in Heroku (you can use [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli) if you want):
```bash
DD_API_KEY=<api_key_from_datadog>
DD_DYNO_HOST=false
HEROKU_APP_NAME=<app_name>
DD_TAGS=service:<meaningful_tag_for_datadog>
```